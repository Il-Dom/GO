<html>
<head>
    <!-- external libraries -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.9/peer.min.js"></script>
	
    <!-- bootstrap for dynamic and responsive html pages -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    
    <!-- stylesheet -->
	<link rel="stylesheet" type="text/css" href="style/styleBoard.css">

    <!-- JavaScript code -->
	<script type="text/javascript">
	var res = "images/"
    var gameBoard;
    var pawnColor;
	/*cambiare nome e valore pawnColor*/
    
        
    function findGroups(acc, pos, color){
        
        if ( acc === undefined || acc.length == 0){
            acc.push(pos);
        }
        else if ( !acc.some(e => e.x === pos.x && e.y===pos.y) ){
            acc.push(pos);
        }
        else{
            return acc;
        }
    
        if( gameBoard[pos.x+1][pos.y] == color && pos.x < gameBoard[0].length){
            acc=findGroups(acc,{'x':pos.x+1,'y':pos.y},color);
        }
        if( gameBoard[pos.x][pos.y-1] == color && pos.y >= 0){
            acc=findGroups(acc,{'x':pos.x,'y':pos.y-1},color);
        }
        if( gameBoard[pos.x-1][pos.y] == color && pos.x >= 0){
            acc=findGroups(acc,{'x':pos.x-1,'y':pos.y},color);
        }
        if( gameBoard[pos.x][pos.y+1] == color && pos.y < gameBoard[0].length){
            acc=findGroups(acc,{'x':pos.x,'y':pos.y+1},color);
        }
            
        return acc;
    }
        
	function retrieveImage( cell, x, y, img, dimen ){
		var corner = "url(\""+res + img +"-corner.png\")";
		var edge = "url(\""+res + img +"-edge.png\")";

		if( x==1 && y==1 ){
			cell.style.backgroundImage = corner;
		}
		else if ( x==dimen && y==1 ){
            $(cell).css("transform", "rotate(270deg)");
			cell.style.backgroundImage = corner;
		}
		else if ( x==dimen && y==dimen ){
            $(cell).css("transform", "rotate(180deg)");
			cell.style.backgroundImage = corner;
		}
		else if ( x==1 && y==dimen ){
            $(cell).css("transform", "rotate(90deg)");
			cell.style.backgroundImage = corner;
		}
		else if( x == 1 ){
			cell.style.backgroundImage = edge;
		} 
		else if( y == 1 ){
            $(cell).css("transform", "rotate(270deg)");
			cell.style.backgroundImage = edge;
		}
		else if( y == dimen ){
            $(cell).css("transform", "rotate(90deg)");
			cell.style.backgroundImage = edge;
		}
		else if( x == dimen ) {
            $(cell).css("transform", "rotate(180deg)");
			cell.style.backgroundImage = edge;
		}
	}
    
	
    function clickListener(obj){
        var middle = Math.ceil( obj.length / 2);
        var x = parseInt(obj.slice(0,middle))-1;
        var y = parseInt(obj.slice(middle))-1;
        
		if( gameBoard [x][y] == 0 ){
			if( turn == 0 ){
				gameBoard[x][y] = 1;
				$('#'+obj).find('div:first').css('background-image','url(images/perla_nera.svg)');
			}
			else{
				gameBoard[x][y] = 2;
				$('#'+obj).find('div:first').css('background-image','url(images/perla_bbianca.svg)');
			}

			$('#'+obj).find('div:first').css('visibility','visible');
			$('#'+obj).unbind('mouseenter mouseleave');

			//var group = findGroups( new Array(),{'x': x, 'y': y}, 1);
			waitForResponse(turn, obj)
		}
    }    

	function waitForResponse(t,pos){
		$("#board").addClass('disabled')//.prop('disabled',true).off('click')
		conn.send({'turn':turn,'position':pos})
	}
      
	function createBoard(dimen){
		var boardW = $('#board').width();
		var boardH = $('#board').height();
		var size = boardW/dimen;
		gameBoard = new Array(dimen).fill(dimen).map(() => new Array(dimen).fill(0));
  
		for(var r = 1; r <= dimen; r++){
			var row = document.createElement("div"); 
			row.className = "row";
			row.id = "row"+digify(r);
			row.style.height = size;

			for(var c = 1; c <= dimen; c++){ 
				/*creating a cell with the relative style*/
                var cell = document.createElement("div"); 
				cell.id = ""+digify(r)+digify(c);
				cell.className = "boardCell";
				cell.style.backgroundImage = "url(\""+res +"wood1-center.png\")";
				cell.style.width = size;
				cell.style.height = size;
				retrieveImage(cell, r, c, "wood1", dimen);				
                
                /*creating pawn and appending to the cell*/
				var pawn = document.createElement('div');
				pawn.className = 'pawn';
				pawn.style.width = size;
				pawn.style.height = size;
                
				cell.appendChild(pawn);

                /*handler functions*/
				$(cell).hover(function(){
                    if(turn){
                        $(this).find('div:first').css('background-image','url(images/perla_bbianca.svg)');
                    }
                    else{
                        $(this).find('div:first').css('background-image','url(images/perla_nera.svg)');
                    }
                    
					$(this).find('div:first').css('visibility','visible');
				},function(){
					$(this).find('div:first').css('visibility','hidden');
				});

                $(cell).on('click',function(){
					clickListener( this.id ); 
                });
                
				row.appendChild(cell); 
			} 
			board.appendChild(row);
		}
	}
    
    function digify(n){ return n > 9 ? "" + n: "0" + n; }

	function grayBoard(message){
		//$("#board *").prop('disabled',true).off('click')
		$("#board").addClass('disabled').addClass('grayed')
		$(".pawn").hide()

		var toInsert = $('<div id=\'errordiv\'>'+message+'</div>')
		var loc = $('#board').offset()
		toInsert.appendTo('#wrapper')
		toInsert.addClass('toInsert')
		toInsert.css('top', ($('#board').outerHeight()- toInsert.height())/2 + loc.top + 'px')
		toInsert.css('left', ($('#board').outerWidth() - toInsert.width())/2 + loc.left + 'px')
	}



	function ungrayBoard(message){
		/*$("#board *").prop('disabled',false).on('click')
		$("#board").removeClass('disabled')
		$(".pawn").show()
		$('#errordiv').remove()*/
		$("#board").removeClass('disabled').removeClass('grayed')
		$(".pawn").show()
		$('#errordiv').remove()
	}
    
	function sendPOSTforPeerIdEliminationtoServer ( peerToRemove ){
		if (peerToRemove != null){
			$.ajax({
				type:'post',
				url: "http://127.0.0.1:8899/removePeer",
				dataType: "text/plain",
				data: JSON.stringify({ "id":  peerToRemove }),
				error: function(a,b,c){
					console.log(c)
				}
			})
		}			
			
	}	

	var peer,conn,turn;  

	function updateTurn(t){
		/*controllo sul messaggio goes here*/
		console.log('entro',t,'onesto')
		turn = ( t+1 ) % 2
		$("#board").removeClass('disabled')
		$('.pawn').show()
	}

	$(document).ready(function(){
		createBoard(19);
		
		var myID = sessionStorage.getItem('connectionID')
		var otherID =  sessionStorage.getItem('otherID') 
		if( myID == null ){
			grayBoard('Invalid ID')
		}
		else{
			peer = new Peer(myID)
			console.log('created peer '+ myID)
			turn = 0

			if(otherID != null){
				console.log("I have to connect with", otherID)
				conn = peer.connect(otherID)

				pawnColor = 1

				conn.on('open', function(){
					console.log('Hi ' + otherID + ' I am '+ myID, 'turn:',turn)
					conn.send({'id': myID})

				})


				conn.on('data', function(t){
					if(t.turn != null){
						turn = t.turn
						console.log('Turno:',t)
						clickListener( t.position )
						updateTurn( t.turn )
					}
				})
				
			}
			else{
				console.log('waiting for peer')
				grayBoard('Waiting for player...')

				pawnColor = 0
				peer.on('connection', function(c) {
					conn = c
					conn.on('open', function() {
						console.log('established connection')
						ungrayBoard()
						sendPOSTforPeerIdEliminationtoServer(myID)
					})

					conn.on( 'data', function(t){
						console.log(t)
						if(t.id != null){
							otherID = t.id
							console.log('connection established with ',otherID,'Turno:',turn,'PawnColor',pawnColor)
						}
						else if(t.turn != null ){
							turn = t.turn
							console.log('Turno:',t)
							clickListener( t.position )
							updateTurn( turn )
						}
					});
				})
			}
		}

		$('#disconnect').on('click',function(){
			
			/*alert("sending elimination request to server")
			
			
			conn.send("Sorry " + otherID + "I've to disconnect myself " + myID)
			

			console.log('message sent '+ myID)
			alert("disconnectiong peer")
			conn.close() 
			peer.disconnect()
			peer.destroy()
			location.href="index.html"*/
			conn.send("Sorry mama for mi vida loca")

		});

		
	});



	</script>

	<title>
	what is the rudest type of elf? a GOfuckyourself
	</title>
	<meta content="">
</head>
<body>
    <div id = 'wrapper'>
		<div id = 'board'> </div>
	</div>

<br>
<br>
<button id = "disconnect" style ="position:absolute; bottom:0;"> disconnect me </button>
</body>
</html>